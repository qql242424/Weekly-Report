#### 死锁检测

![image-20260121144724922](38 3.2.5 手写死锁检测组件   .assets/image-20260121144724922.png)

cpu占用率100%
while(1)

#### 有没有死锁？deaklock

#### 死锁检测的算法

1,有向图是否成环的问题。

#### kv谁占据了这把锁？

![image-20260121150123928](38 3.2.5 手写死锁检测组件   .assets/image-20260121150123928.png)

#### 问题1，如何通过资源找到对应的线程

#### 问题2，如何知道线程想占用资源

#### 1.死锁的构建

测试代码 

![image-20260121152720166](38 3.2.5 手写死锁检测组件   .assets/image-20260121152720166.png)

![image-20260121151425932](38 3.2.5 手写死锁检测组件   .assets/image-20260121151425932.png)



![image-20260121151219474](38 3.2.5 手写死锁检测组件   .assets/image-20260121151219474.png)

创建一个线程，那它就是一个新的线程，它已经可以抢占 CPU 了，所以它就直接可以运行了，不用写 start



![image-20260121152335428](38 3.2.5 手写死锁检测组件   .assets/image-20260121152559015.png)

重命名，把系统的函数弄没了，然后在 init hook 这里再起一个名字，问系统要来。

改善

![image-20260121153341729](38 3.2.5 手写死锁检测组件   .assets/image-20260121153341729.png)

#### 2.有向图的构建

![image-20260121160016073](38 3.2.5 手写死锁检测组件   .assets/image-20260121160016073.png)

3.死锁检测的实现

dfs+回溯算法

#### 线程创建  

![image-20260121160837247](38 3.2.5 手写死锁检测组件   .assets/image-20260121160837247.png)

![image-20260121160757576](38 3.2.5 手写死锁检测组件   .assets/image-20260121160757576.png)

#### 节点和表建立

使用的是全扫描而不是kv，还可以双向索引，并且线程数也不大

![image-20260121161331540](38 3.2.5 手写死锁检测组件   .assets/image-20260121161331540.png)

#### 查表

![image-20260121161231965](38 3.2.5 手写死锁检测组件   .assets/image-20260121161231965.png)

#### 删表

![image-20260121161251508](38 3.2.5 手写死锁检测组件   .assets/image-20260121161251508.png)

#### 增表

![image-20260121161520190](38 3.2.5 手写死锁检测组件   .assets/image-20260121161520190.png)

#### before_lock

自身想+锁之前，看该锁有没有被别人占用

![image-20260121162044879](38 3.2.5 手写死锁检测组件   .assets/image-20260121162044879.png)

#### after_lock

自己+锁后调用的函数

![image-20260121162018090](38 3.2.5 手写死锁检测组件   .assets/image-20260121162018090.png)

#### after_unlock

![image-20260121162443797](38 3.2.5 手写死锁检测组件   .assets/image-20260121162443797.png)

#### 新建一个线程，专门用来检测有没有死锁，每定时5秒检测一次

![image-20260121162311303](38 3.2.5 手写死锁检测组件   .assets/image-20260121162311303.png)